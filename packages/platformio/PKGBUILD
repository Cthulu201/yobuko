# Maintainer: Cthulu201 <cthulu201@duck.com>
# Contributor: Guilhelm Savin <aur@gsav.in>
# Contributor: Jake <aur@ja-ke.tech>

# Upstream URL: https://github.com/platformio/platformio

pkgname=('platformio' 'platformio-udev-rules')
pkgver=6.1.7
pkgrel=1
pkgdesc="A cross-platform code builder and library manager"
arch=('any')
url="https://github.com/platformio/platformio-core"
license=('Apache')
groups=('yobuko')
depends=('python-setuptools'
         'python-bottle'
         'python-click'
         'python-colorama'
         'python-pyserial>=3.4' #https://github.com/platformio/platformio-core/commit/a37eb9868f3b20e982d0c3cd1a742fcb8ab60efc
         'python-requests'
         'python-semantic-version'
         'python-tabulate'
         'python-pyelftools'
         'python-marshmallow'
         'python-zeroconf'
         'python-aiofiles'
         'python-ajsonrpc'
         'python-starlette'
         'python-wsproto'
         'uvicorn')
optdepends=('python-click-completion: for shell completions'
            'python-shellingham:       for shell completions')
conflicts=('platformio-git')
source=("${url}/archive/refs/tags/v${pkgver}.tar.gz")
sha512sums=('de38560e3bafc0ce97836a722122800e9cd31a4c8b6e97cfc9d490ee4d6c5112f87a45d81ec9b191eb4f678c330de4a797be5e176564f6e36fcb9432b47f52d8')

package_platformio() {
  cd "${srcdir}/platformio-core-${pkgver}" || exit
  python setup.py install --root="${pkgdir}/" -O1
}

package_platformio-udev-rules() {
  depends=('udev')
  pkgdesc="udev rules for PlatformIO supported boards/devices"
  url="https://docs.platformio.org/en/latest/faq.html#platformio-udev-rules"

  cd "${srcdir}/platformio-core-${pkgver}" || exit
  install -m644 -Dt "${pkgdir}/usr/lib/udev/rules.d" "platformio/assets/system/99-platformio-udev.rules"
}
